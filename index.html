<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EPUB Library</title>
  <style>
  :root {
    /* Dark Academia Slytherin palette */
    --forest-green: #1a3a2e;    /* deep forest green */
    --emerald: #2d5f4c;         /* rich emerald */
    --sage: #4a7c59;            /* muted sage green */
    --antique-gold: #c9a961;    /* aged brass/gold */
    --deep-gold: #a0894f;       /* darker gold accent */
    --parchment: #f4f1e8;       /* cream/parchment text */
    --aged-paper: #e8e3d3;      /* aged paper */
    --charcoal: #1a2520;        /* very dark green */
    --dark-brown: #162b22;      /* darker forest green */
    --bronze: #8b7355;          /* bronze/brown accent */
  }

  body {
    font-family: 'Garamond', 'Georgia', serif;
    max-width: 900px;
    margin: 2rem auto;
    padding: 0 1rem 3rem;
    line-height: 1.6;

    /* Dark academia background */
    background-color: var(--charcoal);
    color: var(--parchment);
  }

  h1 {
    margin-bottom: 0.5rem;
    color: var(--parchment);
    letter-spacing: 0.08em;
    text-transform: uppercase;
    font-family: 'Georgia', serif;
  }

  h1 span {
    color: var(--antique-gold);
  }

  p {
    color: var(--aged-paper);
  }

  a {
    color: var(--antique-gold);
    text-decoration: none;
    border-bottom: 1px solid transparent;
    transition: all 0.2s ease;
  }

  a:hover {
    border-bottom-color: var(--antique-gold);
    color: var(--deep-gold);
  }

  .search-area {
  margin: 1.5rem 0 2rem;
  padding: 1.25rem 1.5rem;
  border-radius: 0.5rem;

  background: linear-gradient(
    135deg,
    var(--emerald),
    var(--sage)
  );
  border: 2px solid var(--antique-gold);
  box-shadow:
    0 4px 12px rgba(0, 0, 0, 0.5),
    0 0 20px rgba(201, 169, 97, 0.15);
}

#searchInput {
  width: 97%;
  padding: 0.65rem 0.85rem;
  border-radius: 0.4rem;

  background-color: #2a3d34;
  border: 1px solid var(--sage);
  color: var(--parchment);
  font-family: 'Georgia', serif;

  -webkit-appearance: none !important;
  appearance: none !important;
}

#searchInput::placeholder {
  color: var(--aged-paper) !important;
}



  label {
    display: block;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--parchment);
    margin-bottom: 0.35rem;
    font-family: 'Georgia', serif;
  }

  input[type="text"] {
    width: 100%;
    padding: 0.65rem 0.85rem;
    border-radius: 0.4rem;
    border: 1px solid var(--sage);
    background-color: #2a3d34;
    color: var(--parchment);
    font-family: 'Georgia', serif;
  }

  input[type="text"]:focus {
    outline: none;
    border-color: var(--antique-gold);
    box-shadow: 0 0 0 2px rgba(201, 169, 97, 0.3);
  }

  /* fic result card */
  .fic {
  position: relative; /* for absolute positioning of badge */
  background: linear-gradient(
    to bottom,
    var(--forest-green),
    var(--dark-brown)
  );
  border: 2px solid var(--sage);
  border-radius: 0.5rem;
  padding: 1.25rem 1.5rem;
  margin-bottom: 1.25rem;

  box-shadow:
    0 4px 12px rgba(0, 0, 0, 0.6),
    inset 0 1px 0 rgba(74, 124, 89, 0.2);
  color: var(--parchment);
}

.fic h2 {
  margin: 0 0 0.5rem;
  font-size: 1.4rem;
  color: var(--antique-gold);
  font-family: 'Georgia', serif;
  font-weight: 600;
}

.fic h2 a {
  transition: all 0.2s ease;
}

.fic h2 a:hover {
  color: var(--parchment);
  text-shadow: 0 0 8px rgba(201, 169, 97, 0.4);
}

.summary {
  color: var(--aged-paper);
  font-style: italic;
  line-height: 1.6;
}

.meta {
  color: var(--aged-paper);
  font-size: 0.9rem;
  margin-bottom: 0.5rem;
}


  /* tags */
  .tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
    margin-top: 0.6rem;
  }

 .tag {
  font-size: 0.75rem;
  padding: 0.25rem 0.6rem;
  border-radius: 0.3rem;

  background-color: var(--forest-green);
  color: var(--antique-gold);
  border: 1px solid var(--sage);
  font-family: 'Georgia', serif;
  text-transform: lowercase;
  letter-spacing: 0.02em;
}


  /* Cort rec badge */
  .corts {
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
  }

  .cort-badge {
    display: inline-block;
    padding: 0.35rem 0.65rem;
    border-radius: 0.3rem;

    background: linear-gradient(
      135deg,
      var(--emerald),
      var(--sage)
    );
    border: 1.5px solid var(--antique-gold);
    color: var(--parchment);
    font-weight: 600;
    font-size: 0.8rem;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    font-family: 'Georgia', serif;
    box-shadow:
      0 2px 6px rgba(0, 0, 0, 0.5),
      0 0 8px rgba(201, 169, 97, 0.15),
      inset 0 1px 0 rgba(255, 255, 255, 0.1);
  }

  /* "No results" / error state */
  .empty {
    color: var(--aged-paper);
    font-style: italic;
    margin-top: 1rem;
    font-family: 'Georgia', serif;
  }

  /* Library count */
  .library-count {
    color: var(--sage);
    font-family: 'Georgia', serif;
    font-size: 0.9rem;
    margin-bottom: 1.5rem;
    font-style: italic;
  }

  .library-count strong {
    color: var(--antique-gold);
  }

  /* Random Rec Button */
  .random-btn {
    float: right;
    margin-top: 0.5rem;
    padding: 0.4rem 0.8rem;
    border: 1.5px solid #000;
    border-radius: 0.3rem;
    background-color: var(--forest-green);
    color: var(--antique-gold);
    font-family: 'Georgia', serif;
    font-size: 0.85rem;
    font-weight: 600;
    text-transform: lowercase;
    letter-spacing: 0.02em;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .random-btn:hover {
    background-color: var(--emerald);
    border-color: #000;
  }

  .random-btn:active {
    transform: scale(0.98);
  }
</style>


</head>
<body>
  <h1>Book Club EPUB Library</h1>
  <p style="margin-top: -0.4rem; margin-bottom: 0.5rem; font-size: 0.95rem; color: var(--aged-paper); font-family: 'Georgia', serif;">
  Hosted by <strong style="color: var(--antique-gold);">Cort</strong>, <strong style="color: var(--antique-gold);">Deydralinne</strong>, <strong style="color: var(--antique-gold);">Lexi</strong>, and <strong style="color: var(--antique-gold);">Senna</strong>
</p>
  <p class="library-count" id="libraryCount">Loading library...</p>
  <div class="search-area">
    <label for="searchInput"><strong>Search</strong> (title, author, tags, etc.):</label><br />
    <input id="searchInput" type="text" placeholder="Start typing: drarry, coffee shop, author name..." />
    <p style="font-size:0.9rem; color: var(--aged-paper); margin-top:0.35rem; margin-bottom: 0.75rem;">
      This search looks at Title, Author, Main Relationship, Summary, and Tags
    </p>
    <button class="random-btn" id="randomBtn">üé≤ random rec</button>
    <div style="clear: both;"></div>
  </div>

  <div id="results"></div>

  <script>
  // üîó Your published Google Sheet (TSV)
  const SHEET_URL =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vTDrnZp9JF0MARMOJRZYdAEjNj9gB5RnTNcYKIAwA2Grf41H5wQ9OQY7fNH7xE727mkvYkM4nhR56QZ/pub?gid=162465043&single=true&output=tsv";

  // üìö This will hold all your fics from the sheet
  let library = [];

  // üîó Grab elements from the page
  const resultsContainer = document.getElementById("results");
  const searchInput = document.getElementById("searchInput");
  const cortsFilter = document.getElementById("cortsFilter"); // ok if this doesn't exist

  // üßπ Safely lowercase text
  function normalize(value) {
    return (value || "").toString().toLowerCase();
  }

  // üéØ Does this fic match the search text?
  function matchesQuery(item, query) {
    if (!query) return true;
    const q = normalize(query);

    return (
      normalize(item.title).includes(q) ||
      normalize(item.author).includes(q) ||
      normalize(item.mainRelationship).includes(q) ||
      normalize(item.summary).includes(q) ||
      normalize((item.tags || []).join(" ")).includes(q) ||
      normalize(item.cortsTiktokRecs).includes(q)
    );
  }

  // (optional) extra filtering for Cort's recs, if you add a dropdown
  function matchesCortsFilter(item) {
    if (!cortsFilter || !cortsFilter.value || cortsFilter.value === "all") {
      return true;
    }

    if (cortsFilter.value === "corts-only") {
      // Treat anything not FALSE/empty as a rec
      return normalize(item.cortsTiktokRecs) && normalize(item.cortsTiktokRecs) !== "false";
    }

    return true;
  }

  // üñºÔ∏è Render the fic list into the page
  function renderResults(items) {
    if (!resultsContainer) return;

    if (!items.length) {
      resultsContainer.innerHTML =
        '<p class="empty">No results. Try a different search term.</p>';
      return;
    }

   const html = items
  .map((item) => {
    const titleHtml = item.linkOnServer
      ? `<a href="${item.linkOnServer}" target="_blank" rel="noopener noreferrer">${item.title}</a>`
      : item.title;

    const tagsHtml =
      item.tags && item.tags.length
        ? item.tags.map((t) => `<span class="tag">${t}</span>`).join(" ")
        : "";

    // Decide if this is a real Cort Rec (checked box in the sheet)
    // Only show badge if the checkbox is checked (TRUE)
    const cortValue = normalize(item.cortsTiktokRecs).trim();
    const isCortRec = cortValue === "true";

    if (isCortRec) {
      console.log(`Cort Rec detected: "${item.title}" with value: "${item.cortsTiktokRecs}"`);
    }

    const cortsHtml = isCortRec
      ? `<div class="corts"><span class="cort-badge">‚úÖ Cort Rec</span></div>`
      : "";

    return `
      <article class="fic">
        <h2>${titleHtml}</h2>
        <div class="meta">
          <span><strong>Author:</strong> ${item.author || "Unknown"}</span>
          <span><strong>Words:</strong> ${item.words || "?"}</span>
          <span><strong>Chapters:</strong> ${item.chapters || "?"}</span>
          <span><strong>Main Relationship:</strong> ${item.mainRelationship || "‚Äî"}</span>
        </div>
        <p class="summary">${item.summary || ""}</p>
        <div class="tags">${tagsHtml}</div>
        ${cortsHtml}
      </article>
    `;
  })
  .join("");


    resultsContainer.innerHTML = html;
  }
  // üé≤ Pick up to "count" random items from an array
  function getRandomItems(items, count) {
    const copy = [...items]; // shallow copy so we don't mutate the original

    // Fisher‚ÄìYates shuffle
    for (let i = copy.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [copy[i], copy[j]] = [copy[j], copy[i]];
    }

    return copy.slice(0, Math.min(count, copy.length));
  }

  // üîé Apply search + Cort's filter to the library and show results
  function applyFilters() {
    if (!library.length) {
      // no data yet
      if (resultsContainer) {
        resultsContainer.innerHTML = "<p class='empty'>Loading‚Ä¶</p>";
      }
      return;
    }

    const query = searchInput ? searchInput.value.trim() : "";

    // Always respect the Cort's filter first (if you use it)
    let filtered = library.filter((item) => matchesCortsFilter(item));

    if (query) {
      // If there's a search term: filter by text and show ALL matches
      filtered = filtered.filter((item) => matchesQuery(item, query));
      renderResults(filtered);
    } else {
      // If search box is empty: show 5 random fics from the filtered list
      const randomFive = getRandomItems(filtered, 5);
      renderResults(randomFive);
    }
  }


  // üì• Load data from the Google Sheet
  async function loadSheetData() {
    console.log("Fetching sheet from:", SHEET_URL);
    const response = await fetch(SHEET_URL);

    if (!response.ok) {
      throw new Error(`HTTP error! Status: ${response.status} ${response.statusText}`);
    }

    const text = await response.text();
    console.log("Raw sheet text (first 200 chars):", text.slice(0, 200));

    const rows = text
      .trim()
      .split("\n")
      .map((row) => row.split("\t"));

    const [headerRow, ...dataRows] = rows;
    console.log("Headers:", headerRow);

    library = dataRows
      .map((cols) => {
        const [
          title,
          linkOnServer,
          author,
          words,
          chapters,
          mainRelationship,
          summary,
          tags,
          cortsTiktokRecs,
        ] = cols;

        return {
          title: title || "",
          linkOnServer: linkOnServer || "",
          author: author || "",
          words: words || "",
          chapters: chapters || "",
          mainRelationship: mainRelationship || "",
          summary: summary || "",
          tags: tags ? tags.split(",").map((t) => t.trim()) : [],
          cortsTiktokRecs: cortsTiktokRecs || "",
        };
      })
      .filter((item) => item.title && item.title.trim() !== "");

    console.log("Loaded items:", library.length);
    // Debug: Show the first few items and their cortsTiktokRecs values
    console.log("First 3 items with cortsTiktokRecs values:");
    library.slice(0, 3).forEach((item, idx) => {
      console.log(`  [${idx}] ${item.title}: cortsTiktokRecs = "${item.cortsTiktokRecs}"`);
    });

    // Update library count display
    const libraryCountEl = document.getElementById("libraryCount");
    if (libraryCountEl) {
      libraryCountEl.innerHTML = `Our library contains <strong>${library.length}</strong> ${library.length === 1 ? 'fic' : 'fics'}`;
    }
  }

  // üîÅ Wire up events
if (searchInput) {
  const triggerFilter = () => {
    applyFilters();
  };

  // Fire filters for a bunch of interaction types (better mobile support)
  ["input", "keyup", "change", "search"].forEach((evt) => {
    searchInput.addEventListener(evt, triggerFilter);
  });
}

if (cortsFilter) {
  cortsFilter.addEventListener("change", () => {
    applyFilters();
  });
}

// üé≤ Random Rec Button
const randomBtn = document.getElementById("randomBtn");
if (randomBtn) {
  randomBtn.addEventListener("click", () => {
    if (!library.length) return;

    // Clear search box
    if (searchInput) {
      searchInput.value = "";
    }

    // Get a random fic
    const randomFic = library[Math.floor(Math.random() * library.length)];

    // Show just this one fic
    renderResults([randomFic]);
  });
}

document.addEventListener("DOMContentLoaded", async () => {
  await loadSheetData();
  applyFilters();
});

  </script>
</body>
</html>


