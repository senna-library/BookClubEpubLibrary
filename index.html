<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My AO3 EPUB Library</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 900px;
      margin: 2rem auto;
      padding: 0 1rem 3rem;
      line-height: 1.5;
    }

    h1 {
      margin-bottom: 0.5rem;
    }

    .search-area {
      margin-bottom: 1rem;
    }

    #searchInput {
      width: 100%;
      max-width: 450px;
      padding: 0.5rem 0.75rem;
      font-size: 1rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }

    #results {
      margin-top: 1rem;
    }

    .fic {
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 1rem 1.25rem;
      margin-bottom: 1rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.03);
    }

    .fic h2 {
      margin: 0 0 0.25rem;
      font-size: 1.2rem;
    }

    .fic h2 a {
      text-decoration: none;
    }

    .fic h2 a:hover {
      text-decoration: underline;
    }

    .meta {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem 1rem;
      font-size: 0.9rem;
      color: #555;
      margin-bottom: 0.5rem;
    }

    .summary {
      margin: 0.25rem 0 0.5rem;
    }

    .tags {
      margin-top: 0.25rem;
    }

    .tag {
      display: inline-block;
      font-size: 0.8rem;
      padding: 0.1rem 0.5rem;
      border-radius: 999px;
      border: 1px solid #ddd;
      margin: 0 0.25rem 0.25rem 0;
      white-space: nowrap;
    }

    .corts {
      margin-top: 0.5rem;
      font-size: 0.85rem;
      font-style: italic;
      color: #444;
    }

    .empty {
      color: #777;
      font-style: italic;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <h1>BookClub EPUB Library</h1>
  <div class="search-area">
    <label for="searchInput"><strong>Search</strong> (title, author, tags, etc.):</label><br />
    <input id="searchInput" type="text" placeholder="Start typing: drarry, coffee shop, author name..." />
    <p style="font-size:0.9rem; color:#666; margin-top:0.35rem;">
      This search looks at Title, Author, Main Relationship, Summary, Tags, and Corts Tiktok Recs.
    </p>
  </div>

  <div id="results"></div>

  <script>
  // üîó Your published Google Sheet (TSV)
  const SHEET_URL =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vSw2PTQY-cYcZm02BVyXM5opvi7Exun9P0qLFtQvb6Lv5ByPb6vnpsi3lls_hAEyJ6m1hlWXv9pPvgT/pub?gid=162465043&single=true&output=tsv";

  // üìö This will hold all your fics from the sheet
  let library = [];

  // üîó Grab elements from the page
  const resultsContainer = document.getElementById("results");
  const searchInput = document.getElementById("searchInput");
  const cortsFilter = document.getElementById("cortsFilter"); // ok if this doesn't exist

  // üßπ Safely lowercase text
  function normalize(value) {
    return (value || "").toString().toLowerCase();
  }

  // üéØ Does this fic match the search text?
  function matchesQuery(item, query) {
    if (!query) return true;
    const q = normalize(query);

    return (
      normalize(item.title).includes(q) ||
      normalize(item.author).includes(q) ||
      normalize(item.mainRelationship).includes(q) ||
      normalize(item.summary).includes(q) ||
      normalize((item.tags || []).join(" ")).includes(q) ||
      normalize(item.cortsTiktokRecs).includes(q)
    );
  }

  // (optional) extra filtering for Cort's recs, if you add a dropdown
  function matchesCortsFilter(item) {
    if (!cortsFilter || !cortsFilter.value || cortsFilter.value === "all") {
      return true;
    }

    if (cortsFilter.value === "corts-only") {
      // Treat anything not FALSE/empty as a rec
      return normalize(item.cortsTiktokRecs) && normalize(item.cortsTiktokRecs) !== "false";
    }

    return true;
  }

  // üñºÔ∏è Render the fic list into the page
  function renderResults(items) {
    if (!resultsContainer) return;

    if (!items.length) {
      resultsContainer.innerHTML =
        '<p class="empty">No results. Try a different search term.</p>';
      return;
    }

    const html = items
      .map((item) => {
        const titleHtml = item.linkOnServer
          ? `<a href="${item.linkOnServer}" target="_blank" rel="noopener noreferrer">${item.title}</a>`
          : item.title;

        const tagsHtml =
          item.tags && item.tags.length
            ? item.tags.map((t) => `<span class="tag">${t}</span>`).join(" ")
            : "";

        const cortsHtml = item.cortsTiktokRecs
          ? `<div class="corts">Cort's Tiktok Recs: ${item.cortsTiktokRecs}</div>`
          : "";

        return `
          <article class="fic">
            <h2>${titleHtml}</h2>
            <div class="meta">
              <span><strong>Author:</strong> ${item.author || "Unknown"}</span>
              <span><strong>Words:</strong> ${item.words || "?"}</span>
              <span><strong>Chapters:</strong> ${item.chapters || "?"}</span>
              <span><strong>Main Relationship:</strong> ${item.mainRelationship || "‚Äî"}</span>
            </div>
            <p class="summary">${item.summary || ""}</p>
            <div class="tags">${tagsHtml}</div>
            ${cortsHtml}
          </article>
        `;
      })
      .join("");

    resultsContainer.innerHTML = html;
  }
  // üé≤ Pick up to "count" random items from an array
  function getRandomItems(items, count) {
    const copy = [...items]; // shallow copy so we don't mutate the original

    // Fisher‚ÄìYates shuffle
    for (let i = copy.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [copy[i], copy[j]] = [copy[j], copy[i]];
    }

    return copy.slice(0, Math.min(count, copy.length));
  }

  // üîé Apply search + Cort's filter to the library and show results
  function applyFilters() {
    if (!library.length) {
      // no data yet
      if (resultsContainer) {
        resultsContainer.innerHTML = "<p class='empty'>Loading‚Ä¶</p>";
      }
      return;
    }

    const query = searchInput ? searchInput.value.trim() : "";

    // Always respect the Cort's filter first (if you use it)
    let filtered = library.filter((item) => matchesCortsFilter(item));

    if (query) {
      // If there's a search term: filter by text and show ALL matches
      filtered = filtered.filter((item) => matchesQuery(item, query));
      renderResults(filtered);
    } else {
      // If search box is empty: show 5 random fics from the filtered list
      const randomFive = getRandomItems(filtered, 5);
      renderResults(randomFive);
    }
  }


  // üì• Load data from the Google Sheet
  async function loadSheetData() {
    console.log("Fetching sheet from:", SHEET_URL);
    const response = await fetch(SHEET_URL);

    if (!response.ok) {
      throw new Error(`HTTP error! Status: ${response.status} ${response.statusText}`);
    }

    const text = await response.text();
    console.log("Raw sheet text (first 200 chars):", text.slice(0, 200));

    const rows = text
      .trim()
      .split("\n")
      .map((row) => row.split("\t"));

    const [headerRow, ...dataRows] = rows;
    console.log("Headers:", headerRow);

    library = dataRows.map((cols) => {
      const [
        title,
        linkOnServer,
        author,
        words,
        chapters,
        mainRelationship,
        summary,
        tags,
        cortsTiktokRecs,
      ] = cols;

      return {
        title: title || "",
        linkOnServer: linkOnServer || "",
        author: author || "",
        words: words || "",
        chapters: chapters || "",
        mainRelationship: mainRelationship || "",
        summary: summary || "",
        tags: tags ? tags.split(",").map((t) => t.trim()) : [],
        cortsTiktokRecs: cortsTiktokRecs || "",
      };
    });

    console.log("Loaded items:", library.length);
  }

  // üîÅ Wire up events
  if (searchInput) {
    searchInput.addEventListener("input", () => {
      applyFilters();
    });
  }

  if (cortsFilter) {
    cortsFilter.addEventListener("change", () => {
      applyFilters();
    });
  }

  // üöÄ On page load: fetch sheet, then show results
  (async function init() {
    try {
      await loadSheetData();
      applyFilters();
    } catch (err) {
      console.error("Error loading sheet:", err);
      if (resultsContainer) {
        resultsContainer.innerHTML =
          "<p class='empty'>Error loading data from Google Sheets.</p>";
      }
    }
  })();
  </script>
</body>
</html>


